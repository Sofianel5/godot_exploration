[gd_scene load_steps=16 format=3 uid="uid://b4p8qyxvghjm8"]

[ext_resource type="PackedScene" uid="uid://dpqxvpwqjlvff" path="res://scenes/Player.tscn" id="1_0x8b2"]
[ext_resource type="PackedScene" uid="uid://bh8yn4qxd8w7h" path="res://scenes/Enemy.tscn" id="2_3k9m4"]
[ext_resource type="PackedScene" uid="uid://cjxm7y4n8p2qr" path="res://scenes/UI.tscn" id="3_ui"]
[ext_resource type="PackedScene" path="res://models/garden/scene.gltf" id="4_garden"]

[sub_resource type="GDScript" id="GDScript_1"]
script/source = "extends Node3D

var enemy_scene = preload(\"res://scenes/Enemy.tscn\")
var spawn_points = [
	Vector3(5, 1.0, 5),      # Clear area 
	Vector3(-5, 1.0, -5),    # Clear area  
	Vector3(12, 1.0, -3),    # Open area
	Vector3(-12, 1.0, 3),    # Open area
	Vector3(0, 1.0, 15),     # Open center-south
	Vector3(0, 1.0, -15),    # Open center-north
	Vector3(15, 1.0, 0),     # Open center-east
	Vector3(-15, 1.0, 0),    # Open center-west
	Vector3(6, 1.0, -8),     # Open area
	Vector3(-6, 1.0, 5)      # Clear area near center
]

func _ready():
	print(\"Urban combat environment loaded\")

func on_enemy_died():
	print(\"Enemy eliminated! Spawning reinforcement...\")
	
	var timer = Timer.new()
	add_child(timer)
	timer.wait_time = 1.5
	timer.one_shot = true
	timer.timeout.connect(spawn_new_enemy)
	timer.timeout.connect(func(): timer.queue_free())
	timer.start()

func spawn_new_enemy():
	var new_enemy = enemy_scene.instantiate()
	var spawn_pos = spawn_points[randi() % spawn_points.size()]
	new_enemy.global_position = spawn_pos
	add_child(new_enemy)
	
	# Ensure enemy starts with zero velocity
	new_enemy.velocity = Vector3.ZERO
	
	
	print(\"Reinforcement deployed at: \", spawn_pos)

func create_spawn_effect(position: Vector3):
	# Create a bright yellow glowing sphere at spawn location
	var spawn_indicator = MeshInstance3D.new()
	var sphere_mesh = SphereMesh.new()
	sphere_mesh.radius = 0.5
	sphere_mesh.height = 1.0
	
	var spawn_material = StandardMaterial3D.new()
	spawn_material.albedo_color = Color.YELLOW
	spawn_material.emission_enabled = true
	spawn_material.emission = Color.YELLOW
	spawn_material.emission_energy = 2.0
	
	spawn_indicator.mesh = sphere_mesh
	spawn_indicator.material_override = spawn_material
	spawn_indicator.global_position = position + Vector3(0, 2, 0)  # Slightly above ground
	
	add_child(spawn_indicator)
	
	# Make it pulse and disappear after 3 seconds
	var tween = create_tween()
	tween.set_parallel(true)
	
	# Pulse effect
	tween.tween_method(
		func(scale_val): spawn_indicator.scale = Vector3.ONE * scale_val,
		1.0, 1.5, 0.5
	)
	tween.tween_method(
		func(scale_val): spawn_indicator.scale = Vector3.ONE * scale_val,
		1.5, 1.0, 0.5
	).set_delay(0.5)
	
	# Fade out after 2.5 seconds
	tween.tween_method(
		func(alpha): spawn_material.albedo_color.a = alpha,
		1.0, 0.0, 0.5
	).set_delay(2.5)
	
	# Remove after 3 seconds using Timer instead of tween_delay
	var cleanup_timer = Timer.new()
	add_child(cleanup_timer)
	cleanup_timer.wait_time = 3.0
	cleanup_timer.one_shot = true
	cleanup_timer.timeout.connect(func(): 
		spawn_indicator.queue_free()
		cleanup_timer.queue_free()
	)
	cleanup_timer.start()
"

[sub_resource type="StandardMaterial3D" id="GroundMaterial"]
albedo_color = Color(0.3, 0.35, 0.3, 1)
metallic = 0.1
roughness = 0.8

[sub_resource type="PlaneMesh" id="PlaneMesh_1"]
size = Vector2(60, 60)

[sub_resource type="BoxShape3D" id="BoxShape3D_1"]
size = Vector3(2, 2, 2)

[sub_resource type="StandardMaterial3D" id="BuildingMaterial"]
albedo_color = Color(0.35, 0.35, 0.4, 1)
metallic = 0.3
roughness = 0.6

[sub_resource type="BoxMesh" id="BuildingMesh"]
size = Vector3(6, 12, 6)

[sub_resource type="StandardMaterial3D" id="PillarMaterial"]
albedo_color = Color(0.7, 0.65, 0.6, 1)
roughness = 0.5

[sub_resource type="CylinderMesh" id="PillarMesh"]
top_radius = 0.8
bottom_radius = 0.8
height = 8.0

[sub_resource type="CylinderShape3D" id="CylinderShape3D_1"]
height = 8.0

[sub_resource type="StandardMaterial3D" id="WallMaterial"]
albedo_color = Color(0.5, 0.5, 0.6, 1)
metallic = 0.2
roughness = 0.7

[sub_resource type="BoxMesh" id="BoxMesh_1"]

[sub_resource type="Environment" id="Environment_1"]
background_mode = 1
background_color = Color(0.15, 0.2, 0.25, 1)
ambient_light_source = 2
ambient_light_color = Color(0.7, 0.8, 1, 1)
ambient_light_energy = 0.3
fog_enabled = true
fog_light_color = Color(0.4, 0.5, 0.6, 1)
fog_sun_scatter = 0.2

[node name="Main" type="Node3D"]
script = SubResource("GDScript_1")

[node name="Environment" type="Node3D" parent="."]

[node name="Garden" type="Node3D" parent="Environment"]

[node name="Bush1" parent="Environment/Garden" instance=ExtResource("4_garden")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 5, 0, -10)

[node name="Bush2" parent="Environment/Garden" instance=ExtResource("4_garden")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -7, 0, 12)

[node name="Bush3" parent="Environment/Garden" instance=ExtResource("4_garden")]
transform = Transform3D(1.5, 0, 0, 0, 1.5, 0, 0, 0, 1.5, 10, 0, 5)

[node name="Bush4" parent="Environment/Garden" instance=ExtResource("4_garden")]
transform = Transform3D(0.8, 0, 0, 0, 0.8, 0, 0, 0, 0.8, -15, 0, -5)

[node name="Ground" type="StaticBody3D" parent="Environment"]
collision_layer = 2

[node name="GroundMesh" type="MeshInstance3D" parent="Environment/Ground"]
material_override = SubResource("GroundMaterial")
mesh = SubResource("PlaneMesh_1")

[node name="GroundCollision" type="CollisionShape3D" parent="Environment/Ground"]
transform = Transform3D(50, 0, 0, 0, 1, 0, 0, 0, 50, 0, -1, 0)
shape = SubResource("BoxShape3D_1")




[node name="Lighting" type="Node3D" parent="."]

[node name="SunLight" type="DirectionalLight3D" parent="Lighting"]
transform = Transform3D(0.707107, -0.5, 0.5, 0, 0.707107, 0.707107, -0.707107, -0.5, 0.5, 0, 10, 0)
light_energy = 1.2
shadow_enabled = true

[node name="FillLight" type="DirectionalLight3D" parent="Lighting"]
transform = Transform3D(-0.707107, -0.3, -0.3, 0, 0.707107, -0.707107, 0.707107, -0.5, -0.5, 0, 8, 0)
light_color = Color(0.8, 0.9, 1, 1)
light_energy = 0.3

[node name="WorldEnvironment" type="WorldEnvironment" parent="."]
environment = SubResource("Environment_1")

[node name="Player" parent="." instance=ExtResource("1_0x8b2")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1.1, 0)

[node name="Enemy" parent="." instance=ExtResource("2_3k9m4")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 10, 1.0, 8)

[node name="UI" parent="." instance=ExtResource("3_ui")]
grow_horizontal = 2
grow_vertical = 2
